{% extends "base.html" %}

{% block title %}Dashboard - NWK Image System{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>System Overview</h2>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div>Total Products</div>
            <div class="stat-number">{{ stats.total_products }}</div>
            <div>In Database</div>
        </div>
        
        <div class="stat-card approved">
            <div>Approved</div>
            <div class="stat-number">{{ stats.approved }}</div>
            <div>Ready for Export</div>
        </div>
        
        <div class="stat-card pending">
            <div>Pending Review</div>
            <div class="stat-number">{{ stats.pending }}</div>
            <div>Needs Attention</div>
        </div>
        
        <div class="stat-card declined">
            <div>Declined</div>
            <div class="stat-number">{{ stats.declined }}</div>
            <div>Can Be Cleared</div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>Progress</h2>
    </div>
    
    <div class="progress-bar">
        <div class="progress-fill" style="width: {{ stats.completion_percentage }}%">
            {{ "%.1f"|format(stats.completion_percentage) }}% Complete
        </div>
    </div>
    
    <p>
        <strong>{{ stats.approved }}</strong> of <strong>{{ stats.total_products }}</strong> products have approved images.
    </p>
    <p>
        <strong>{{ stats.not_processed }}</strong> products have not been processed yet.
    </p>
</div>

<div class="card">
    <div class="card-header">
        <h2>Quick Actions</h2>
    </div>
    
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{{ url_for('import_page') }}" class="btn">Import New Excel</a>
        
        {% if stats.not_processed > 0 %}
        <button class="btn btn-success" onclick="startProcessing()">
            Process {{ stats.not_processed if stats.not_processed < 10 else 10 }} Products
        </button>
        {% endif %}
        
        {% if stats.pending > 0 %}
        <a href="{{ url_for('review_page') }}" class="btn btn-warning">
            Review {{ stats.pending }} Pending Images
        </a>
        {% endif %}
        
        <a href="{{ url_for('export_page') }}" class="btn">Export Results</a>
    </div>
</div>

<div class="card" id="processing-status" style="display: none;">
    <div class="card-header">
        <h2>Processing Status</h2>
    </div>
    
    <div id="processing-info">
        <div class="progress-bar">
            <div class="progress-fill" id="processing-progress" style="width: 0%">
                0%
            </div>
        </div>
        <p id="processing-message">Initializing...</p>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>System Health</h2>
    </div>
    
    <div id="system-health">
        <p>Checking connections...</p>
    </div>
</div>

<script>
// Start processing - ensure available globally
window.startProcessing = async function() {
    // Safety check - wait for functions to be available
    if (typeof apiCall !== 'function' || typeof showAlert !== 'function') {
        alert('Functions not ready yet. Please wait a moment and try again.');
        return;
    }
    
    if (!confirm('Start processing the next 10 products?')) return;
    
    try {
        const result = await apiCall('/api/process', 'POST', { limit: 10 });
        showAlert('Processing started!', 'success');
        
        document.getElementById('processing-status').style.display = 'block';
        checkProgress();
        
    } catch (error) {
        showAlert('Failed to start processing: ' + error.message, 'error');
    }
}

// Check progress - ensure available globally
window.checkProgress = async function() {
    try {
        const state = await apiCall('/api/progress');
        
        if (state.is_running) {
            const progress = state.progress;
            const percentage = (progress.current / progress.total * 100).toFixed(0);
            
            document.getElementById('processing-progress').style.width = percentage + '%';
            document.getElementById('processing-progress').textContent = percentage + '%';
            document.getElementById('processing-message').textContent = 
                `Processing ${progress.current} of ${progress.total}: ${progress.product || 'Unknown'}`;
            
            // Check again in 1 second
            setTimeout(checkProgress, 1000);
            
        } else {
            document.getElementById('processing-message').textContent = 'Processing complete!';
            
            // Reload stats
            setTimeout(() => location.reload(), 2000);
        }
        
    } catch (error) {
        console.error('Progress check error:', error);
    }
}

// Check system health - ensure available globally
window.checkSystemHealth = async function() {
    try {
        const health = await apiCall('/api/test-connection');
        
        let html = '<ul>';
        html += `<li>Database: ${health.database ? '✅ Connected' : '❌ Not Connected'}</li>`;
        html += `<li>API Key: ${health.api_key ? '✅ Configured' : '❌ Not Configured'}</li>`;
        html += `<li>Folders: ${health.folders ? '✅ Ready' : '❌ Missing'}</li>`;
        html += '</ul>';
        
        document.getElementById('system-health').innerHTML = html;
        
    } catch (error) {
        document.getElementById('system-health').innerHTML = 
            '<p class="alert alert-error">Failed to check system health</p>';
    }
}

// Initialize when DOM and functions are ready
document.addEventListener('DOMContentLoaded', function() {
    // Wait for functions to be available before initializing
    const initializeDashboard = function() {
        if (typeof apiCall === 'function') {
            console.log('Dashboard functions available, initializing...');
            
            // Check system health on page load
            checkSystemHealth();

            // Check if processing is already running
            apiCall('/api/progress').then(state => {
                if (state.is_running) {
                    document.getElementById('processing-status').style.display = 'block';
                    checkProgress();
                }
            }).catch(error => {
                console.warn('Could not check initial processing status:', error);
            });
        } else {
            // Retry in 100ms if functions not available yet
            setTimeout(initializeDashboard, 100);
        }
    };
    
    initializeDashboard();
});
</script>

{% endblock %}